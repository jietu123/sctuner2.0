

# SVG 插件问题解决报告

（Problem Analysis & Resolution Report）

------

## **一、问题背景（Problem Background）**

在 SVTuner 的模块化优化设计中，“优化一”旨在利用**空间变异基因（Spatially Variable Genes, SVG）**提升细胞–空间位点映射的空间结构表达能力。

然而在最近的讨论中我们提出一个关键担忧：

> **虽然我们已经能够从 ST 数据中识别出 SVG，但 Cytospace 是否真正使用了这些 SVG？
>  是否可能实际上仍然基于 HVG（高变基因）进行映射，从而导致 SVG 插件形同虚设？**

这一问题直击项目核心，因为：

- 若 Cytospace 完全没用 SVG → 插件无意义
- 若 Cytospace 虽然使用了 SVG，但处理方式与 HVG 完全一致 → SVG 的空间结构优势无法体现
- 若我们无法证明“SVG 优化版本 ≠ HVG baseline” → 文章无法写、创新点无法成立

因此，本报告系统分析上述问题的风险，并提出可验证、可操作的解决方案。

------

## **二、问题拆解（Problem Decomposition）**

SVG 插件面临的风险可分为 3 类：

------

### **风险 1：我们识别了 SVG，但 Cytospace “根本没看到”它们**

表现为：

- 我们算了一个 SVG 列表（CSV / JSON）
- 但 Cytospace 的输入表达矩阵依旧是 HVG 版本
- Cytospace 求解过程完全没有接触 SVG

➡️ **这是最严重也最常见的风险**
 ➡️ 原因：Cytospace 不会主动读取你额外的 SVG 列表

------

### **风险 2：Cytospace 确实使用了 SVG，但与 HVG 无差别处理**

即：

- 输入矩阵中同时包含 HVG 和 SVG
- 但 Cytospace 计算相似度时只是做普通的基因向量距离/相关性
- 并没有专门强调 SVG 的权重

➡️ **导致 SVG 空间模式优势无法有效影响最终映射**
 ➡️ 映射结果可能与 HVG-only 版本几乎一致 → 插件不具备发表价值

------

### **风险 3：我们无法证明 Cytospace 是否使用 SVG（论文无法写）**

即使 Cytospace 使用了 SVG，也要面对同行评审的核心质疑：

> “请证明你的模型确实利用了 SVG，并且 SVG 的信息改善了映射。”

如果没有明确的**对照实验 + SVG 敏感指标**：

- 差异不明显 → 文章无法建立贡献点
- 没有指标证明 → 审稿人无法信服

------

## **三、问题根源（Root Cause）**

1. **Cytospace 本身不包含 SVG/HVG 区分逻辑**
   - 输入基因是什么，它就用什么
   - 不会主动强化“空间变异特征”
2. **我们的 SVG 与 Cytospace 的求解机制是解耦的**
   - Cytospace 只关心表达矩阵
   - SVG 只是我们额外检测出的列表，不改变任何矩阵内容
3. **现有流程缺乏“严格设计的对照实验”与“SVG 专属评估指标”**
   - 用什么基因都跑一样 → 很难证明 SVG 的作用
   - 没有 SVG 空间结构指标 → 提升难以量化

------

## **四、解决方案（Proposed Solutions）**

为了系统解决三个风险，本方案提供 3 层干预策略：**输入层 → 特征层 → 后验仲裁层**。

这些策略完全符合 SVTuner 的“非侵入式外挂设计”，无需修改 Cytospace 内核。

------

# **解决方案 A：构建“SVG 驱动版” Cytospace 输入矩阵（强制 Cytospace 使用 SVG）**

### **核心思想：改变 Cytospace 的“输入特征空间”**

> Cytospace 的一切决策都是基于输入基因表达矩阵。
>  因此，只要我们改变输入矩阵的基因集合或基因数量，就能控制它“使用 SVG”。

具体实施：

### **A-1：构建三套基因集作为对照实验**

| 名称                     | 内容           | 用途                    |
| ------------------------ | -------------- | ----------------------- |
| **HVG-only（baseline）** | 标准 HVG       | 原始 Cytospace 效果基线 |
| **SVG-only**             | 仅包含 SVG     | 强测试 SVG 作用         |
| **HVG ∩ SVG（交集）**    | 高变且空间变异 | 尖锐表达与结构特征融合  |
| **HVG ∪ SVG（并集）**    | 综合特征       | 实际使用中最常用        |

在 Cytospace 中运行四次：

```
run(hvg_only)
run(svg_only)
run(hvg_intersect_svg)
run(hvg_union_svg)
```

### 解决效果：

- 绝对保证 Cytospace “使用”了 SVG（因为输入只有 SVG）
- 能观察不同特征空间导致的映射变化
- 论文可清晰给出对照实验

------

# **解决方案 B：SVG 基因加权（让 SVG 在 Cytospace 的相似度计算中更重要）**

### **核心思想：不改变基因集合，而是改变“基因的数值权重”**

例如：

```
X[:, g_svg] = X[:, g_svg] * 3.0   # 放大 SVG 的表达权重
```

作用：

- Cytospace 在算表达距离/相关性时，SVG 对 cost matrix 的贡献更大
- 保留 HVG 的整体表达结构
- 缓解 SVG-only 可能“太激进”的问题

这一策略可写成：

> “通过特征加权（feature rescaling），增强 SVG 在映射中的贡献度。”

------

# **解决方案 C：SVG 后验一致性仲裁（让 SVG 成为映射好坏的评价者）**

即使 Cytospace 内部没有专门处理 SVG，我们可以在 SVTuner 仲裁阶段利用 SVG：

### **流程：**

1. 用 Cytospace 得到初始映射
2. 根据映射重构 SVG 基因在 ST 空间的表达（pred）
3. 与真实 ST SVG 表达（obs）进行对比
4. 计算一系列 SVG 一致性指标：
   - SVG 相关性 (R²)
   - SVG 残差空间自相关（Moran’s I）
   - SVG 特定区域 cell-type 结构一致性
5. 仲裁时更加偏向：
   - 能提高 SVG 解释度
   - 且不破坏细胞数量约束、表达一致性的映射方案

### 影响：

- 让 SVG 成为“裁判官”
- 在不修改 Cytospace 内核的前提下利用 SVG
- 可直接写成论文创新点：“SVG-aware post-hoc tuning”

------

## **五、验证方案（Verification Plan）**

为了科研可发表，我们必须证明：
 **SVG 优化方案与 baseline HVG 映射结果在 SVG 空间结构上产生了显著差异与提升。**

因此设计如下三大类验证指标。

------

# **验证 1：SVG 表达重构准确度（核心指标）**

对于每个 SVG 基因 g：

```
obs_g(spot)    # ST 实际表达
pred_g(spot)   # 通过 mapping + scRNA 重构的 expression
corr_g = corr(obs_g, pred_g)
```

比较：

| 指标                         | 期望现象                                         |
| ---------------------------- | ------------------------------------------------ |
| SVG corr ↑                   | SVG-only 或 SVG-weighted 映射应显著高于 HVG-only |
| SVG RMSE ↓                   | 重构误差减少                                     |
| SVG 空间自相关（Moran’s I）↓ | 残差趋于随机而非有结构                           |

------

# **验证 2：映射分布稳定性（稳定性感知项目高度相关）**

在相同 seed 下：

- HVG-only → 两次结果差异较大
- SVG-driven → 更稳定（因为 SVG 空间结构信号更明确）

稳定性指标：

- 细胞空间分布 KL
- Mean cell-wise entropy
- Spot-wise similarity (cosine/EMD)

------

# **验证 3：生物学区域一致性验证**

如：

- 海马分区
- 皮层层板
- 肿瘤区域 / 边缘区域

SVG 对这些区域通常具有特异模式。

若映射更加符合已有生物学知识，可说明：

> SVG 有助于增强空间结构解释能力。

------

## **六、最终报告性总结（Final Summary）**

> **SVG 插件不是“找出 SVG 列表”那么简单，而是必须显式介入 Cytospace 的特征空间或后验决策流程，确保 Cytospace 真正利用 SVG 的空间结构特性。**

本报告给出的三个解决方案，可彻底解决原始问题：

| 问题                              | 对应解决方案                     |
| --------------------------------- | -------------------------------- |
| Cytospace 没用 SVG                | A：构建 SVG 驱动输入矩阵         |
| Cytospace 使用了 SVG 但无差别处理 | B：SVG 特征加权                  |
| 无法证明 SVG 有效性               | C + 验证方案：SVG 一致性指标体系 |

最终，你的论文可以清晰表述：

- 我们不仅计算了 SVG
- 而且**强制 Cytospace 使用它 / 强调它 / 依据它优化映射**
- 并且通过严格的对照实验证明 SVG 带来了空间结构上的优势

------

## 如果你愿意，我可以进一步为你输出：

### ✔ 一份正式论文版的 “SVG 插件方法学章节”

### ✔ 一份实验流程图（用于论文或 PPT）

### ✔ 一套可直接用的 Python 代码模板：

- 自动构建 SVG/HVG 基因集
- 生成加权表达矩阵
- 运行 Cytospace
- 计算 SVG 一致性指标

你需要哪一部分？
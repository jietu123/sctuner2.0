# 阶段四、阶段五和 SimGen 阶段的详细设计方案

## 路线二的目标和概述

**目标：** 路线二旨在提供一种新的单细胞（scRNA-seq）与空间转录组（ST）数据整合管道，实现单细胞精度的映射，并能够检测两种数据集中细胞类型组成差异。与之前的方法相比，新方案在保持关键评估指标的同时，重点关注检测 **S0**/**S1** 场景下的细胞类型缺失问题。其中，**S0** 场景指ST数据中缺少某种在SC数据中存在的细胞类型，**S1** 场景指SC数据和ST数据各有一种对方不存在的细胞类型。

**主要改动：**

- **阶段2移除：** 删除原阶段二的处理步骤及其输出，使管道更简化（阶段三直接作为基础输入）。
- **阶段3保留：** 沿用原阶段三的结果作为地基，不对其算法修改。阶段三产出一个“细胞类型构成表”，提供每个空间位置的细胞类型丰度估计，可视作参考的细胞类型分布。
- **阶段4重新设计：** 采用类似 *CytoSPACE* 的映射策略，实现单细胞到空间位置的线性指派分配。阶段四在映射之前**先执行类型过滤**，然后利用阶段三的细胞类型表（过滤后）和推断的每个spot细胞数量，构建细胞池并进行优化匹配。映射完成后即直接作为最终结果（不再使用阶段三结果进行后验优化）。
- **阶段5简化：** 新的阶段五仅负责差异细胞类型的**检测**，不再对映射结果做复杂后验调整。当前重点实现 **S0** 场景的检测，即找出“仅在SC中存在而在ST中缺失”的细胞类型；**S1** 场景的检测留作扩展，实现方案将在本设计中提出但暂不开发。阶段五不会产生复杂的中间文件，只输出检测结果的 JSON。
- **SimGen阶段聚焦场景模拟：** 重新设计模拟数据生成阶段（SimGen），只包括两个场景：S0和S1。通过对原始数据进行抽取/修改来生成**S0模拟数据集**（SC含有某类型而ST不含）和**S1模拟数据集**（SC和ST各含有对方缺失的类型），用于验证阶段五的检测能力。
- **评估指标保留：** 尽可能沿用原有方案中的评估指标用于比较和验证。例如，可保留映射精度（如spot表达重构的相关性）、细胞类型分布差异等指标，确保新旧方案结果的可比性。
- **输出格式简化：** 精简各阶段输出。阶段四的主要输出为映射分配结果（例如每个spot的细胞列表或细胞类型构成），阶段五输出JSON格式的检测结果（缺失的细胞类型列表等）。除必要结果外尽量不输出冗余的中间文件。
- **可复现性：** 支持随机种子（`seed`）参数，以确保涉及随机过程的步骤结果可复现。所有在阶段四映射和SimGen模拟中涉及随机抽样的地方，均使用指定的种子初始化随机数生成器，从而每次运行得到一致的结果。

## 阶段四：单细胞到空间位置的映射 (Mapping)

阶段四采用CytoSPACE算法思想，将单细胞表达数据映射到空间转录组的捕获点（spot）。该阶段利用阶段三提供的细胞类型分布信息，对单细胞数据进行过滤和重采样，然后通过线性指派算法完成最优匹配。映射过程以最小化空间表达差异为目标，并满足每个spot含有固定数量细胞的约束。[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=replacement or by introducing placeholder,An efficient integer)

### 输入与类型过滤

- **输入数据：** 阶段四需要以下输入：
  1. **单细胞数据 (SC)：** 包含所有单细胞的基因表达矩阵及其细胞类型标签。
  2. **空间数据 (ST)：** 每个spot的基因表达向量（通常为转录本counts或UMI counts）。
  3. **阶段三细胞类型构成表：** 由阶段三推断得到的每个spot的细胞类型丰度/数量估计矩阵。该表提供了ST样本中各细胞类型的预测存在情况和比例，可视为参考的细胞类型丰度[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)（例如可由RCTD或cell2location等方法得到每个spot的细胞类型比例）。
- **过滤步骤：** 在正式映射之前，依据阶段三的构成表对细胞类型进行过滤：
  - **SC特有类型过滤：** 查找阶段三结果中，在**所有**空间spot上预测丰度为0的细胞类型。如果某细胞类型在SC数据集中存在（有单细胞属于该类型），但阶段三推断其在ST中丰度近乎为零（低于某阈值，或完全为0），则认为该类型在ST样本中缺失。这样的类型记为候选的S0缺失类型。从后续映射中将这些类型**排除**，即不考虑将此类细胞映射到任何spot上。这一步防止在映射时试图安置那些实际上不存在于空间数据中的细胞类型，避免产生错误匹配。被过滤的细胞类型列表将被记录下来，供阶段五用于报告检测结果。
  - **（可选）ST特有类型标记：** 如果存在反向情况，即ST数据中出现了阶段三无法解释的新细胞表达模式（暗示存在SC参考中没有的细胞类型），理论上也需考虑。但由于SC参考数据不包含该类型的单细胞，本阶段无法直接处理此类“空间特有”类型。在当前实现中，我们假定参考SC覆盖了主要的细胞类型，忽略ST特有类型在映射阶段的处理（此问题将在S1检测方案中讨论）。若将来需要，也可以在此记录下任何**可能**的ST特有类型信号（例如阶段三方法提供了“未分配”部分的情况下），供后续检测分析。

### 空间spot细胞数量估计

为了给每个空间spot分配适当数量的单细胞，我们需要估计每个spot中包含的细胞总数（记为 $N_j$ 表示spot $j$ 的细胞数）。CytoSPACE默认通过RNA总量估计每个spot的细胞数[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=based on RNA abundance estimation,3b–e  and  59)。我们将采用类似方法：

- **UMI计数法：** 计算每个spot的转录本总计数（例如UMI counts之和），作为该spot的RNA总量指标。设 $T_j$ 为spot $j$ 的总UMI数。计算单细胞数据中每个细胞的平均UMI数或中位数，记为 $\bar{T}_{cell}$。则初步估计spot $j$ 的细胞数：
   $N_j = \text{round}\left(\frac{T_j}{\bar{T}_{cell}}\right)$
   即将spot的总RNA量除以单细胞平均RNA量[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)。我们对该值取整（四舍五入）得到一个整数细胞数。若计算结果低于1，则强制设定 $N_j = 1$，保证每个spot至少分配1个细胞。
- **调整与验证：** 得到所有spot的 ${N_j}$ 后，可计算总需求细胞数 $N_{\text{total}} = \sum_j N_j$。此总数即为需要从单细胞数据集中选取（采样）的细胞总量。可以对比 $N_{\text{total}}$ 与原始SC细胞总数，确保有足够的细胞用于分配。如果 $N_{\text{total}}$ 明显大于可用的单细胞数且某些类型严重不足，后续步骤中会通过重复采样（上采样）来补足。
- **（可选改进）：** 如果有更精细的细胞数估计手段（如基于组织切片影像的细胞分割计数），也可取代纯RNA量估计。但在当前方案中，将以UMI推断为主，以保持简单和通用。

### 构建细胞池

有了每个spot所需的细胞数量和类型分布预测，我们从单细胞数据构建一个“细胞池”，即待分配的单细胞集合。目标是使细胞池在数量和类型构成上匹配空间数据的需求[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=segmentation approaches29 %2C 69%2C can,representation%2C either by drawing with)：

- **类型构成匹配：** 利用阶段三输出的细胞类型构成表指导采样。对于每个细胞类型 $t$（经过过滤的类型集合内）：
  - 计算该类型在ST中的总需求细胞数 $M_t$。方法是，将阶段三预测的每个spot中类型 $t$ 的细胞数相加：$M_t = \sum_{j} n_{j,t}$，其中 $n_{j,t}$ 是阶段三预测的spot $j$中类型$t$的细胞数量（若阶段三给出的是比例，可按 $n_{j,t} = f_{j,t} \times N_j$ 取整得到预估数量）。汇总所有spot得到类型$t$的总需求 $M_t$。[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=two parameters are required%3A ,Upsampling)
  - 如某类型 $t$ 属于之前标记的“缺失类型”（被过滤掉），则其需求 $M_t=0$，后续不会为其选取细胞。
  - 对于每个有需求的类型$t$，从单细胞数据中抽取$M_t$个属于类型$t$的细胞加入细胞池。**抽样策略：\**如果SC数据集中该类型的实际细胞数不少于$M_t$，可以随机选择$M_t$个不同细胞（不放回抽样）。如果SC中该类型细胞不足$M_t$，则采用\**有放回抽样**（即允许重复使用某些细胞）以凑够所需数量[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=segmentation approaches29 %2C 69%2C can,representation%2C either by drawing with)。在抽样过程中使用固定的随机种子以确保结果可重复。
  - 如有必要，抽样时也可考虑保持spot级别的分布：一种做法是分spot执行抽样，每个spot抽取$n_{j,t}$个类型$t$细胞，这样各spot初始分配的类型组成与阶段三预测一致。然而，为简化实现，我们可先按总体$M_t$抽取，再在指派算法中由成本函数决定具体哪些细胞去哪些spot。这两种方式在总数匹配的前提下应不影响最终结果，因为线性指派会根据表达相似度自动进行优化分配。
- **随机种子与复现：** 抽样过程涉及随机选择细胞，因此在代码实现时需接受`seed`参数来初始化随机数生成器（例如使用`random.seed(seed)`），确保多次运行选中相同的细胞集合[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=Although most steps of the,ran CytoSPACE ten times with)[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=number of cells per spot,seq data)。这一点对于结果复现和调试非常重要。
- **细胞池结果：** 完成上述步骤后，我们得到一个大小为 $N_{\text{total}}$ 的细胞池（列表）。其中包含按需要数量抽取的单细胞，每个细胞保留其原始表达向量和细胞类型标签。在这个细胞池中，各类型细胞的数量分布与阶段三预测的ST组成尽可能一致[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=segmentation approaches29 %2C 69%2C can,representation%2C either by drawing with)。如果由于取整等原因导致总数与$N_{\text{total}}$不符，可对抽样略作调整（例如对差额部分随机增减某些类型的细胞）以确保池中细胞总数精确等于所有spot需求总和。

### 线性指派映射

准备好细胞池和每个spot所需的细胞数量后，采用线性指派（Linear Assignment）算法求解单细胞到空间spot的最优匹配。[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=replacement or by introducing placeholder,An efficient integer)映射目标是**最小化**重构的空间表达与实际观测表达之间的差异，相当于最大程度解释空间转录组信号。具体方案如下：

- **问题建模：** 将映射任务建模为一个带有成本函数的二分匹配问题：
  - 视每一个待分配的单细胞为一个“供给”单位（供给总数等于细胞池大小）。
  - 视每个空间spot的每个“席位(slot)”为一个“需求”单位：如果spot $j$需要 $N_j$ 个细胞，则创建 $N_j$ 个独立的席位表示该spot的需求。这样所有席位总数等于 $\sum_j N_j = N_{\text{total}}$，与细胞池供给总数相等。我们将这些席位记为$(j, k)$，表示spot $j$的第$k$个细胞位置，其中 $k = 1,...,N_j$。
  - 定义成本函数 $Cost(i, j)$ 来衡量单细胞 $i$ 放置到spot $j$的“不匹配程度”。为了使指派结果尽可能解释spot的基因表达，我们采用**基于表达谱相关性**的成本：
     $Cost(i,j) = 1 - \text{corr}(\mathbf{x}_i,\ \mathbf{y}_j)$
     其中 $\mathbf{x}_i$ 表示单细胞 $i$ 的表达向量，$\mathbf{y}_j$ 表示spot $j$ 的表达向量。$\text{corr}(\cdot,\cdot)$是皮尔逊相关系数。此成本定义使得如果细胞 $i$ 的表达特征与spot $j$ 非常相似（相关系数高），则成本较低；反之，如果不相似则成本高。最小化该成本等价于**最大化**细胞表达与对应spot表达的相关性。
    - *注：* 实际实现中，为提高稳健性，我们可对表达向量进行适当标准化或加权（例如对每个基因标准化表达或者只选取高变基因计算相关性），但原则是不变的，即以匹配表达模式为核心目标。
  - **约束条件：** 每个单细胞 $i$ 只能被指派到**一个**席位（即一个spot的位置），每个席位只能得到**一个**单细胞的指派。并且，由于席位总数和细胞总数相等，自然满足每个细胞都被分配且每个spot获得确切的$N_j$个细胞的要求。[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=replacement or by introducing placeholder,An efficient integer)
- **求解方法：** 以上匹配问题为典型的线性指派问题，可采用**匈牙利算法**（Hungarian Algorithm）或其改进版求解。CytoSPACE中使用了Jonker-Volgenant的最短增广路算法实现高效求解[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=replacement or by introducing placeholder,An efficient integer)。我们可以利用现有的优化库或实现Hungarian算法来求解成本矩阵最小匹配：
  - **构建成本矩阵：** 构造矩阵 $C$，维度为 (细胞池大小) × (席位总数)。行对应每个单细胞$i$，列对应每个spot的席位$(j,k)$。矩阵元素 $C[i,(j,k)] = Cost(i,j)$ 即单细胞 $i$ 分配到spot $j$的成本（与具体席位$k$无关，同一spot的席位成本列是重复的，因为cost只与spot和细胞有关）。
  - **执行指派算法：** 输入成本矩阵 $C$ 到线性指派求解器，求解最小总成本的匹配。算法将返回一个最优匹配，对应每个单细胞 $i$ 被指派到某个唯一的spot席位 $(j,k)$。由于我们构造了足够的席位，确保每个spot正好获得$N_j$个细胞满足需求。
  - **复杂度与性能：** 成本矩阵规模为 $N_{\text{total}}\times N_{\text{total}}$（假设供需平衡）。虽然最坏情况复杂度较高（Hungarian算法 $O(n^3)$），但在典型数据规模下（如几千细胞、几百spot），现代实现足以在合理时间内完成[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=highly efficient%2C processing a Visium,Fig)。若数据特别大，可考虑使用近似算法或分块策略，但本设计暂假定数据规模可控。
  - **随机性：** 指派算法本身是确定性的（给定成本矩阵总能找到相同的最优解）。若存在多解同样最优，标准实现通常仍会返回固定解。因此，映射结果在固定输入下是可重复的。一旦细胞池的采样受seed控制，阶段四的整体结果即可复现。
- **结果重构验证：** 通过匹配结果，我们可重构每个spot的表达：将指派到该spot的所有单细胞表达向量求和，得到重构的spot表达$\hat{\mathbf{y}}*j = \sum*{i \in S_j} \mathbf{x}_i$（$S_j$为指派到spot $j$的细胞集合）。可以计算重构与实际$\mathbf{y}_j$之间的相似度（如皮尔逊相关或MSE）来评估映射质量。理论上，优化过程已经近似最大化了这种相似度。[nature.com](https://www.nature.com/articles/s41587-023-01697-9?error=cookies_not_supported&code=e8c6597d-0198-4544-8437-7e392dcdedcb#:~:text=correlation,Methods)我们会保留以下指标供评估：
  - 每个spot的重构表达与真实表达的相关系数或R<sup>2</sup>。
  - 全部spot的平均相关系数，以及最低相关系数的spot（检查是否有映射不佳的区域）。
  - 如果有真实位置或类型标注（例如模拟数据有真值），也可以计算匹配的准确度指标，如正确映射率等（供SimGen模拟评测用）。
- **细胞类型分布核对：** 虽然我们没有在算法中强制每个spot的类型组成与阶段三预测完全一致，但由于我们构建池时已保证各类型总数符合预测，并且cost函数倾向于把表达模式相符的细胞放到对应spot，因此最终每个spot的类型构成应与阶段三结果大体吻合。在需要时，我们可以统计输出的映射结果中每个spot的细胞类型组成，与阶段三的预测表进行对比，计算比如每类型的匹配误差等指标，用于分析映射和预测的一致性。

### 阶段四输出

- **映射结果：** 阶段四输出每个spot的细胞分配结果。可采用JSON或CSV等格式列出：
  - 方案1：按spot列出所包含的细胞ID及其类型。例如：`{ spot_1: [cell_5(typeA), cell_42(typeB), ...], spot_2: [...], ... }`。
  - 方案2：输出每个单细胞的指派位置。例如表格包含两列：`cell_id` 和 `assigned_spot`，表示每个细胞去了哪个spot。
  - 也可同时输出汇总的**细胞类型组成矩阵**（spots × cell types），表示映射后每个spot各类型细胞数。这相当于对指派结果按类型做一个聚合，可用于直观比较阶段三预测。
- **缺失类型记录：** 从过滤步骤得到的“SC特有缺失类型”列表也应保存（如果在阶段四未另存，可由阶段五重新依据阶段三和SC类型集推导）。建议将其包含在阶段四或阶段五的输出中，以明确指出哪些类型在映射中被排除。
- **评估指标：** 若需要验证映射效果，以上提到的相关系数等指标可在日志或一个报告文件中输出。但为了简化输出，这些指标可以仅用于内部评估，不强制作为对外输出文件。若用户需要，也可将整体相关系数等写入一个JSON或文本报告。例如：`{"mean_spot_correlation": 0.92, "min_spot_correlation": 0.75}` 等。
- **文件命名规范：** 推荐使用清晰的命名，例如：
  - 映射结果文件：`mapping_assignment.json` 或 `mapping_results.csv`。
  - 若输出类型组成矩阵：`mapped_composition.csv`。
  - 指标文件：`mapping_metrics.json`。
  - 这些文件可以置于一个阶段输出目录下，并包含路线二或实验名称前缀以避免混淆（例如`route2_stage4_mapping.json`）。

## 阶段五：差异细胞类型检测 (Detection Stage)

阶段五负责检测单细胞数据和空间数据之间细胞类型组成的不一致情况，聚焦于识别**缺失的细胞类型**。在我们的定义中，“缺失”意味着某细胞类型存在于一个数据集中但在另一个中不存在。根据之前说明，主要分为S0和S1两种场景：

- **S0 场景（单向缺失）：** 某种细胞类型在SC数据中存在，但在ST数据中完全缺失。
- **S1 场景（双向交叉缺失）：** 存在至少两种细胞类型：其中一种仅存在于SC数据而缺失于ST（类似S0的情况），同时另一种仅存在于ST数据而在SC参考中缺失。

当前实现将**优先处理S0场景**，即找出所有“SC特有而ST缺失”的类型；对于S1场景，仅提出设计方案，暂不在代码中实现。

### S0场景：SC中存在但ST中缺失的类型检测

**检测思路：** 我们利用阶段三的细胞类型构成推断结果，直接比较SC和ST的细胞类型集合。当某类型在SC里有细胞，但阶段三推断其在ST的丰度为0（或极微小）时，即可判定该类型在ST中缺失。具体步骤：

1. **获取细胞类型列表：** 从SC单细胞数据提取所有细胞类型的列表（记为集合 $Type_{SC}$）。从阶段三的ST细胞类型构成表中提取在任意spot上预测数量 > 0 的细胞类型列表（记为 $Type_{ST}$）。由于阶段三的推断通常只输出SC提供的类型集合中的值（不会凭空产生新类型），$Type_{ST}$应是经过过滤的SC类型子集。

2. **比较集合差异：** 计算 $Type_{miss} = Type_{SC} \setminus Type_{ST}$。集合$Type_{miss}$中的每个类型即满足：在SC中存在、在ST预测中不存在。对这些类型逐一检查：

   - 若阶段三对于该类型在所有spot预测都是0，则确认其缺失。这通常已经由集合差异得到。
   - 可以进一步核实SC中该类型细胞数量是否足够多以值得关注（例如是否可能只是极罕见类型导致预测漏检）。根据需求可设定一个SC端细胞数阈值，例如SC中至少有$n$个细胞的类型却完全未出现在ST，可视作显著缺失。如果某类型在SC非常少（比如只有1个细胞）且ST没检测到，也许可以忽略或标记为低置信度。但初版实现可不考虑阈值，简单地报告所有缺失类型。

3. **输出结果：** 将$Type_{miss}$列表作为S0场景的检测结果输出。输出格式为JSON，例如：

   ```
   {
       "missing_in_ST": ["细胞类型A", "细胞类型B", ...]
   }
   ```

   其中`missing_in_ST`键对应的数组列出了所有在空间数据中缺失的细胞类型（它们在单细胞数据中出现过）。

   - 如果需要包含更多信息，可以加入每种类型在SC中的细胞数量、该类型典型的marker基因等，但这些属于扩展信息，不是检测必须输出的内容。
   - 此JSON文件命名可为`detected_missing_types.json`或`stage5_detection.json`，以清楚表明内容。

**验证与后续处理：** S0检测结果本质上来自阶段三的推断。如果是模拟数据（如SimGen生成的数据），我们可以通过已知真值验证这些输出是否正确。例如检查SimGen S0场景中有意移除的类型是否在报告中列出。在真实数据应用中，报告的缺失类型可提示生物学家：空间转录组实验可能未捕获这些细胞，需要警惕技术原因或组织学差异。

### S1场景：双向细胞类型缺失的检测（设计方案）

*S1场景暂不实施，此节为未来扩展设计。*

在S1场景下，我们面临更复杂的情况：既有类型在ST中缺失（如S0），又有类型在SC参考中缺失但实际上出现在ST样本中。后者意味着存在空间数据中特有的细胞类型，未被单细胞参考捕获。检测S1需要同时识别这两种差异。实现方案包括：

1. **识别ST中特有类型候选：** 因为SC参考中没有某类型，我们无法直接从阶段三输出获取它。但可以从**空间数据本身**出发，寻找可能的新类型信号：

   - **残差表达分析：** 使用阶段四的映射结果，计算每个spot的表达残差向量：$\mathbf{r}_j = \mathbf{y}_j - \hat{\mathbf{y}}_j$，其中$\hat{\mathbf{y}}_j$是映射的重构表达。如果空间中存在参考没有的新细胞类型，那么映射无法解释这部分细胞的基因表达，该spot会残留明显的未解释基因信号$\mathbf{r}_j$。
   - 汇总所有spot的残差，例如进行主成分分析(PCA)或聚类，寻找是否存在系统性的表达模式未被解释。比如，一组空间邻近的spots具有相似的残差表达谱，且这些残差富含某些基因的高表达，那么这可能对应一个未在SC参考中出现的细胞类型群。
   - **未知类型聚类：** 对残差表达谱进行聚类，尝试将未解释信号归为一种或几种“未知细胞类型”。例如，如果发现残差中存在一簇基因一起高表达（可能是某细胞类型的marker集合），可推断出一个候选的未知细胞类型。我们可将其暂定名为“UnknownType1”等。
   - 另一个角度是直接对空间数据做无监督聚类或分解，尝试识别参考之外的新类别。但由于空间数据是混合信号，这较为困难。残差分析利用了参考来先解释已知类型，提高了发现未知的敏感性。

2. **验证未知类型贡献：** 一旦怀疑存在ST特有类型，例如通过上述残差模式发现了UnknownType1：

   - 可以检查这些残差主要出现在哪些spots，以及这些spots的组织空间位置是否聚集成特定区域。这可能佐证其生物学合理性（比如某新细胞类型集中于特定组织区）。
   - 检查残差中的高表达基因是否在SC参考的任何细胞类型中表达都很低。这确认这些基因信号确实未被参考解释，支持这是新类型的marker基因组。
   - 如果具备其它信息源（如空间组织学图像或蛋白marker），也可交叉验证这些spots是否存在未标注的细胞。

3. **输出ST缺失于SC的类型：** 一旦识别出一个或多个候选的空间特有类型，我们需要在输出中报告。在最终实现中，阶段五输出JSON可扩展为：

   ```
   {
       "missing_in_ST": [...], 
       "missing_in_SC": [
           {
             "type": "UnknownType1",
             "marker_genes": ["GeneX", "GeneY", ...],
             "affected_spots": [spot10, spot11, ...]
           }
         ]
   }
   ```

   这里`missing_in_SC`列出ST中存在但SC缺少的类型列表。由于这些类型在参考中没有名字，我们可以用Unknown标签并提供一些特征信息（如推断的marker基因、主要出现区域等）以帮助理解。

   - 初步实现中，我们可能不深入鉴定marker，只需报告在ST中存在未知类型的迹象。例如输出：`"missing_in_SC": ["Unknown cell population present"]` 或类似的提示。
   - 若能确定是哪一种具体细胞类型（例如通过额外实验发现其实SC缺了一种已知类型），也可以更新报告。但自动鉴定超出纯算法范围。

4. **识别SC缺失类型（重复S0）：** S1场景同时也意味着存在SC->ST缺失类型，可按前述S0方法识别。这部分在S1情况下依然有效。所以完整的S1检测应包括：

   - Missing_in_ST 列表（同S0）
   - Missing_in_SC 列表（由残差/未知类型分析得到）

5. **实现考虑：** S1检测涉及较复杂的分析和可能的参数（如如何判定残差显著、聚类如何选取分群数等）。初期可以从简单指标入手，例如：

   - 计算每个spot的映射重构误差（例如MSE或1-相关性）。如果有一批spots误差显著偏高，可能提示未知类型存在于那些spots。
   - 收集高误差spots的共同差异基因，看能否组成合理的基因集。
   - 这些分析可以辅助人工判断。在自动化实现前，也可先输出残差或误差信息供用户检查。
   - 等方案成熟，再将其固化为自动检测逻辑输出Missing_in_SC结果。

### 阶段五输出格式

正如上述，阶段五输出主要是关于缺失类型的报告。最终格式采用JSON，以便机器易读且结构清晰：

- **S0结果输出：** 默认情况下提供`"missing_in_ST"`键，其值为数组，列出所有在空间数据中未出现的细胞类型（来自SC）。如果没有发现此类类型（两数据集类型集合完全一致），则该数组为空。例：

  ```
  { "missing_in_ST": ["TypeA", "TypeB"] }
  ```

- **S1结果输出（扩展）：** 完全实现S1检测后，JSON将增加一个`"missing_in_SC"`键用于描述空间中特有类型。由于这些类型在SC中无现成名称，可能使用占位名和附加信息对象。如前节所示，可以用对象数组包含一些描述。但在简化版本中，可仅列出占位名或简单提示。例如：

  ```
  { 
    "missing_in_ST": ["TypeA"], 
    "missing_in_SC": ["UnknownType1"] 
  }
  ```

  如果没有检测到任何空间特有类型，则`missing_in_SC`可以省略或给空数组。

- **文件输出：** 阶段五的JSON结果文件可以命名为`route2_stage5_detection.json`或类似名称。由于阶段五不生成其他中间数据，此JSON是主要输出成果。

- **日志和其他：** 阶段五过程中的计算（比如每种类型SC和ST的计数、残差分析统计等）可记录在日志，方便调试和验证。但这些不需要输出给用户，只需内部保留或在需要时通过参数输出。

## SimGen阶段：场景数据生成

SimGen阶段用于生成模拟数据，以验证上述管道在已知差异场景下的表现。我们定义两类模拟场景数据：

- **S0模拟数据集：** 从原始数据衍生出一种情形：单细胞参考中某细胞类型存在，但在空间转录组数据中人为**移除**该类型。这样的模拟ST数据缺少该类型细胞的表达信号，从而验证阶段五能否识别出该缺失类型。
- **S1模拟数据集：** 构造一个同时具有双向缺失的情形：移除一种类型A使其仅存在于SC（ST缺A），同时移除另一种类型B使其仅存在于ST（SC缺B）。这需要同时修改SC和ST数据，模拟互有差异的情况，用于今后测试S1检测方案。

模拟生成将以原始真实数据为基础进行修改，或完全基于单细胞数据构建虚拟ST。以下详细说明每种场景生成的方法。

### S0模拟场景生成

**目标：** 选择一种细胞类型，使之在生成的ST数据中缺失，而SC数据仍保留该类型。这样我们获得一对数据集：(SC<sub>S0</sub>, ST<sub>S0</sub>)，满足S0条件。

**生成步骤：**

1. **选择类型X：** 从原始单细胞数据的细胞类型集合中选择一个细胞类型 X 作为“缺失候选”。理想选择是原始数据中同时存在于SC和ST的类型之一，以便移除后形成差异。可以由用户指定类型X；如未指定，可随机选择一种类型（非必需保留的关键类型）。为保证模拟意义，X类型在SC中应有足够细胞数且在原ST中有一定存在，以观察移除影响。设置随机种子以保证每次选择相同的类型用于模拟（如果随机的话）。
2. **构造ST<sub>S0</sub>：** 生成新的空间表达数据，使类型X不再出现。这里有两种策略：
   - **基于原ST改造：** 如果原始ST数据和阶段三结果可用，我们可以利用原ST的细胞类型构成估计来去除X型贡献。例如，对于原ST的每个spot：
     - 查看阶段三预测的该spot中类型X的数量$n_{j,X}$。假设我们信任此值代表该spot约有$n_{j,X}$个X细胞贡献了表达。
     - 从原始SC数据中随机抽取$n_{j,X}$个类型X的单细胞表达，将它们的表达和从spot表达中扣除（减去这些细胞的counts和）的方式来模拟移除X型。当然，实际实现复杂，因为直接减去会遇到基因表达负值问题（若选取的细胞表达在spot中并非线性可分）。一种简化是：干脆将所有与类型X密切相关的marker基因从spot表达中去除或大幅降低。然而这可能影响其他类型表达。
     - 更可靠的方法是采用**重构思路**：重新生成每个spot的表达，而不是修改原spot。利用阶段三的组成预测（除去X类型）重新混合单细胞表达：
       - 对每个spot，拿原阶段三的细胞构成${n_{j,t}}$，将类型X的数量设为0：$n'_{j,X}=0$；其他类型保持原预测值或可稍作调整填补空缺（例如将原本属于X的细胞数在该spot按比例分配给其他类型，保持总细胞数不变，或干脆总细胞数减少）。
       - 然后按照调整后的${n'_{j,t}}$，从SC数据中抽取对应数量的细胞（类型X的不抽取），将这些细胞的表达相加得到spot $j$的新表达向量。
       - 如此生成所有spot的新表达矩阵，即为ST<sub>S0</sub>。这个过程相当于模拟了一次没有类型X存在的空间捕获实验。
   - **纯合成生成：** 不依赖原ST数据，只用SC数据构造一个全新ST：
     - 设定模拟ST的spot数量（可与原ST相同，或自定一个数目）。可以沿用原ST的空间坐标布局以保持可视化对应（如果有需要）。
     - 决定每个模拟spot的总细胞数，可基于原ST的分布或统一设定（比如平均5个细胞/spot，添加随机波动）。使用随机种子生成这些数量。
     - 决定每个spot的细胞类型组成。在S0模拟中，不允许出现类型X。可以参考原ST中各类型比例作为基准，将X的份额分给其他类型按比例增加，或者简单地在除X外的类型中随机抽取组成。
     - 根据确定的组合，从SC数据抽取对应类型和数量的单细胞，将表达累加为spot表达。
     - 这样得到的ST<sub>S0</sub>是完全模拟的，但由于借用了真实单细胞表达，具有生物真实感，只是缺少了类型X的贡献。
   - 两种方法各有利弊：基于原ST改造保持与原数据更接近的噪声水平和空间结构，纯合成则更灵活且实现简单。在设计上，我们倾向于**重构生成**的方法，即利用阶段三推断构成来指导重新混合，从而既保持原始spot特征（总细胞数、主要类型比例），又确保去除了目标类型X。
3. **构造SC<sub>S0</sub>：** S0场景下，单细胞参考数据保持原样即可，因为我们需要SC中有类型X存在。因此SC<sub>S0</sub>可以直接用原始SC数据（或者为了严格对应，可以是原SC数据的一个子集/重排，但不移除X类型）。为了模拟贴近真实，可使用原SC完整数据，不做修改。
   - 注意如果原SC数据量非常大，也可抽取一部分以降低计算量，但要确保类型X在SC中仍有代表。
4. **输出：** 产生的模拟数据包括：
   - **SC<sub>S0</sub>**：与原始SC相同格式的数据集（细胞×基因矩阵及细胞注释），其中包含类型X。
   - **ST<sub>S0</sub>**：新的空间表达矩阵（spot×基因），其中不含类型X的表达贡献。可以采用和原ST相同的格式（例如SpatialExperiment对象或包含坐标的矩阵文件）。如果沿用了原ST的spot坐标，则输出时可以保持spot顺序和坐标不变，仅更新表达矩阵，以方便对照原数据。
   - **真值记录：** 可以输出一个简单的JSON或文本，记录模拟所做的改动。例如：`{"S0_removed_type": "TypeX"}`，明确指出哪种类型被从ST中移除。这在评估检测算法时很有用。文件命名如`sim_S0_info.json`。
   - 命名上，可加后缀标识S0，例如`sim_S0_st_data.h5ad`（如果使用AnnData/H5AD格式）或`sim_S0_spot_matrix.csv`等，SC数据可以不加S0后缀（因为与原SC相同）或者另存为`sim_S0_sc_data.h5ad`（内容实际上等同原SC）。
5. **验证：** 生成后，可对ST<sub>S0</sub>运行阶段三的推断算法，确保类型X预测为0，从而模拟出我们预期的“缺失信号”。然后可通过运行阶段四和阶段五，检验是否正确检测出类型X。SimGen主要为测试流程服务，因此验证结果是否符合预期是关键一步。

### S1模拟场景生成

**目标：** 生成一对数据集 (SC<sub>S1</sub>, ST<sub>S1</sub>)，其中存在双向的细胞类型缺失：类型A仅存在于SC<sub>S1</sub>而缺失于ST<sub>S1</sub>，类型B仅存在于ST<sub>S1</sub>而缺失于SC<sub>S1</sub>。这样可模拟参考不完备的情况，测试管道识别双方缺失的能力。

**生成步骤：**

1. **选择类型A和B：** 从原始细胞类型集合中挑选两个不同的类型A和B：

   - 类型A将从ST中移除（如S0场景那样），但在SC中保留。
   - 类型B将从SC中移除，但希望其在ST中存在。
   - 通常选择A和B均为原本在数据中存在的类型。选择需确保：原SC中有类型B的细胞，原ST中有类型A的存在（以便移除和模拟）。如果原始ST本身没有B，那模拟ST加上B也可以，但一般尽量选双方本来都有的类型以符合真实。
   - 用户可指定A和B；否则可随机选取两个类型。使用随机种子保证每次选择一致。

2. **构造SC<sub>S1</sub>：** 从原始SC数据中**移除类型B**的所有细胞，得到新的SC参考数据。

   - 这表示SC<sub>S1</sub>不包含类型B（模拟该类型在单细胞测序参考中未捕获）。其余类型的细胞保持不变，包括类型A仍在其中。
   - 格式与原SC相同，只是过滤掉所有细胞类型为B的条目。需要更新细胞类型列表（去掉B）。

3. **构造ST<sub>S1</sub>：** 生成新的ST数据，需要满足：不含类型A，但含类型B（即类型B的贡献仍存在）。

   - 可以采用类似S0的重构思路：利用阶段三预测构成，设类型A在所有spots的$n'_{j,A}=0$（移除A），类型B保持原预测值（或者如果阶段三受限于SC类型集合可能没有给B的分布，这里需要人工指定B的分布）。
   - **关键点：** 如果原阶段三是基于原SC推断的，那么原SC包含B，所以阶段三结果应该有B在ST的预测。如果原SC参考有B且ST也有该类型表达特征，阶段三应输出一个$n_{j,B}$。我们可以保留这些$n_{j,B}$以在模拟ST中体现B的存在。
   - 为安全起见，可以按原阶段三的${n_{j,t}}$，设置：
     - $n'_{j,A} = 0$（移除A型细胞）
     - 对于其他类型 $t \neq A$，令 $n'*{j,t} = n*{j,t}$ 原值。特别地，类型B的$n'_{j,B}$就是原预测值（代表B本应存在的数量）。
     - 如果移除A导致某些spot总细胞数减少，也可以选择是否补偿：一种做法是不补偿，让那些spot总数变为$N'*j = N_j - n*{j,A}$；另一种是将A的配额按比例分给其他类型（包括B）以保持总数。这里可以简单地不补偿，使模拟更直观：ST<sub>S1</sub>整体少了A型细胞，那总细胞也略微减少。这样不影响检测逻辑，只是在映射时总细胞数差异需要考虑。但为简单，可不额外分配，以免引入偏差。
   - 根据调整后的${n'_{j,t}}$，从原始SC数据中抽取细胞来重构每个spot表达：
     - 对每个spot $j$，对于每种类型 $t\neq A$，抽取 $n'_{j,t}$ 个该类型的单细胞（来自原SC）。
     - 注意：即使我们从SC<sub>S1</sub>中移除了B，但在生成ST<sub>S1</sub>时，可以也**必须**从原SC的数据拿类型B的细胞来注入ST（因为我们假想真实空间中有B型细胞，只是SC参考没捕获，但不妨碍我们用原数据里的B细胞当作“真实存在”的细胞来构造ST）。也就是说，虽然SC<sub>S1</sub>不含B，但我们仍利用原SC的B细胞表达来模拟ST的B信号。这是模拟过程中的“真值”利用，并不违背实验设定，因为我们仅用于生成数据而不会提供这些B细胞给映射算法。
     - 将抽取的所有细胞表达累加得到spot $j$ 的表达向量。
   - 完成所有spots的重构后，得到ST<sub>S1</sub>表达矩阵。其中类型A的贡献已移除，类型B的表达存在（来自原SC的B细胞），其他类型保持原貌。
   - ST<sub>S1</sub>的spot坐标可以与原ST相同（对应spot顺序不变），以方便比较。

4. **输出：** 模拟完成后，输出：

   - **SC<sub>S1</sub>：** 滤除了类型B的单细胞数据（格式同原始SC）。

   - **ST<sub>S1</sub>：** 移除了类型A的空间表达数据（格式同原ST）。

   - **信息记录：** JSON记录所移除的类型A（ST缺失）和类型B（SC缺失），如：

     ```
     { "S1_removed_from_ST": "TypeA", "S1_removed_from_SC": "TypeB" }
     ```

     这作为模拟真值，便于核对检测结果应报告缺失A于ST，缺失B于SC。

   - 文件命名：类似`sim_S1_sc_data.h5ad`，`sim_S1_st_data.h5ad`，以及`sim_S1_info.json`。

5. **验证：** 可对生成的ST<sub>S1</sub>运行阶段三算法（需注意其SC参考用SC<sub>S1</sub>不含B，所以阶段三不会预测B类型），预期结果：

   - 阶段三应该预测类型A在ST中为0（因为我们移除了A）。
   - 阶段三无法预测类型B（因SC缺B），可能将B型细胞的表达误归类为其他现有类型或充当未解释残差。如果我们的模拟显著，映射阶段（阶段四）在那些含B信号的spots上可能出现较大残差，从而在阶段五的S1检测中被发现为UnknownType。
   - 通过运行完整管道，我们期望阶段五 S0部分报告缺失类型A，在未来实现的S1部分能侦测到有未知类型存在（对应B）。在暂未实现S1自动检测的情况下，可人工检查映射残差或阶段三的拟合不佳之处来验证类型B的影响。

### SimGen阶段输出和种子设定

SimGen输出的模拟数据将与真实数据格式一致，以便直接投入阶段三到阶段五流程运行。总结输出内容：

- **模拟SC数据集**（仅S1场景的SC<sub>S1</sub>与原始不同；S0场景SC基本原样）。格式例如单细胞表达矩阵文件或AnnData对象，含细胞注释。
- **模拟ST数据集**（S0和S1均新生成）。格式例如空间表达矩阵，附带spot坐标信息（如果需要可沿用原ST坐标）。
- **场景说明JSON**，记录移除了哪些类型用于日后比对。
- **命名规范：** 使用场景名称方便识别，例如文件名包含`S0`或`S1`。可以将两个场景的数据分别放在不同子目录（如`sim_S0/`, `sim_S1/`）。

随机性的控制在SimGen同样重要：

- **类型选择随机性：** 如果未指定A或X等类型，算法随机挑选类型进行移除。这使用随机种子来保证可重复得到相同选择。
- **组成随机性：** 在纯合成生成时，每个spot的组成随机生成，也需用种子控制。
- **细胞抽样随机性：** 和阶段四类似，从SC中抽取细胞构建spot是随机的（有放回）。所有这些随机步骤应统一使用传入的`seed`，或在SimGen内自行设定种子，以确保每次生成的模拟数据一致。

通过以上设计，SimGen阶段能够产出可控的测试数据，配合阶段四和五验证我们的路线二管道功能。模拟数据允许我们在已知答案的情况下调整算法参数、评估检测准确率，并逐步完善对S1复杂情形的处理。
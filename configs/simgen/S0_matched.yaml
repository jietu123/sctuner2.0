scenario_id: "S0_matched"
description: "S0: fully matched (Query 与 ST 类型体系一致)"
seed: 42

# 输入模板：默认复用 data/processed/real_brca/stage1_preprocess/exported/
input_sample: "real_brca"

# 基因面板：建议先用 real_brca 的 HVG（更快、更稳），需要更全可改 common 或指定 gene_panel_path
gene_panel: "hvg"          # hvg | common
n_genes_max: null          # 可选：截断基因数，例如 2000

# 类型清洗（R4）
type_cleaning:
  min_cells_per_type: 30
  low_count_policy: "merge_to_other"   # drop | merge_to_other
  other_name: "Other"
  merge_map_path: null                # 可选：CSV，列 orig_type,new_type

# World/Query/Ref 拆分（P0/P5）
world_fraction: 0.6
query_fraction: 0.4
ref_fraction: 0.0
allow_world_ref_overlap: false
allow_world_query_overlap: false
allow_ref_query_overlap: false

# 空间与 spot 网格
space_width: 1000
space_height: 1000
block_nx: 5
block_ny: 5
block_mixture:
  primary_weight: 0.50
  neighbor_weight: 0.30
  background_weight: 0.20
spot_grid_nx: 25
spot_grid_ny: 25
spot_radius: 80
min_cells_per_spot: 2

# 覆盖率兜底（P4：不允许 drop_empty_spots，spot_id 必须保持不变）
coverage_fallback: ["expand_radius", "resample_world"]
max_radius_multiplier: 2.0
max_resample_rounds: 10
max_empty_spot_fraction: 0.30
min_cells_per_spot_satisfied_fraction_warn: 0.50

# 类型不匹配控制
sc_missing_types: []
st_missing_types: []

# Query 真值规则（P2）
query_truth_policy: "nearest_spot_after_sampling_xy"

# counts-space 生成与归一化导出（R2/R3）
counts:
  counts_source: "pseudo_from_norm"   # raw | pseudo_from_norm（当前实现支持 pseudo_from_norm）
  target_depth: 5000
  scale_factor: 10000

noise:
  libsize_mode: "lognormal"           # lognormal | none
  libsize_sigma: 0.3
  noise_level: 1.0                    # 0=不加 Poisson 噪声（仅四舍五入），>0=Poisson

# capacity 约束：SimGen 会输出 st_coordinates.csv 的 spot_cell_counts，使其总和 = n_query_cells（便于 cell-level 对齐）
capacity_policy: "world_density"      # world_density | uniform
capacity_clip_min: 1

# Stage1 兼容基因列表（非 exported 目录；仅输出少量 txt，避免后续缺文件返工）
stage1_compat_gene_lists:
  enabled: true
  source_sample: "real_brca"
  filter_to_sim_common: true
  generate_if_missing: true
  hvg_cap_n_top: 1000
  min_hvg_after_filter: 300
  hvg_fallback:
    method: "variance"
    n_top: 1000
  write_manifest: true
